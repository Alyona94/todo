<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>TODO</title>
  </head>
  <body>
    <h1>TODO список</h1>

    <form id="taskForm">
      <input type="text" id="title" placeholder="Название задачи" required />
      <input type="text" id="description" placeholder="Описание задачи" />
      <button type="submit">Добавить</button>
    </form>

    <h2>Задачи:</h2>
    <div id="tasks"></div>

    <script>
      const API_URL = "/tasks";

      async function loadTasks() {
        const res = await fetch(API_URL);
        const tasks = await res.json();

        const tasksContainer = document.getElementById("tasks");
        tasksContainer.innerHTML = "";

        tasks.forEach((task) => {
          const div = document.createElement("div");
          div.className = "task";
          div.dataset.taskId = task.id;
          div.innerHTML = `
        <input type='checkbox' ${
          task.completed ? "checked" : ""
        } onchange='toggleDone(${task.id}, this.checked)' />
        <input type='text' name='title' value='${task.title}'  />
        <input type='text' name='description' value='${task.description}' />
        <div>
          <button onclick="deleteTask(${task.id})">❌</button>
          <button onclick="updateTask(${task.id})">✏️</button>
        </div>
      `;
          tasksContainer.appendChild(div);
        });
      }

      document
        .getElementById("taskForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const title = document.getElementById("title").value;
          const description = document.getElementById("description").value;
          await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, description }),
          });

          document.getElementById("title").value = "";
          document.getElementById("description").value = "";
          loadTasks();
        });

      async function toggleDone(id, completed) {
        await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ completed }),
        });
        loadTasks();
      }
      async function deleteTask(id) {
        await fetch(`${API_URL}/${id}`, {
          method: "DELETE",
        });
        loadTasks();
      }

      async function updateTask(id) {
        const taskDiv = document.querySelector(`.task[data-task-id="${id}"]`);
        if (!taskDiv) return;

        const title =
          taskDiv.querySelector('input[name="title"]')?.value?.trim() ?? "";
        const description =
          taskDiv.querySelector('input[name="description"]')?.value ?? "";

        if (!title) {
          alert("title is required");
          return;
        }

        await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, description }),
        });

        loadTasks();
      }
      loadTasks();
    </script>
  </body>
</html>
